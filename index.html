

      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .badge {
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 700;
      font-size: 14px;
      letter-spacing: .2px;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
    }
    .timer {
      font-variant-numeric: tabular-nums;
      background: rgba(116,192,252,.12);
      border-color: rgba(116,192,252,.30);
    }
    .timer.danger {
      background: rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.35);
    }
    main { padding: 18px; }
    .panel {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 18px;
    }
    h1, h2 { margin: 0 0 8px 0; }
    h1 { font-size: 26px; }
    h2 { font-size: 20px; color: var(--muted); font-weight: 650; }
    p { margin: 10px 0; color: var(--muted); line-height: 1.45; }
    .question { font-size: 22px; line-height: 1.25; font-weight: 800; margin-top: 8px; }
    .answers { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 14px; }
    button {
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 14px 14px;
      border-radius: 14px;
      font-size: 16px;
      cursor: pointer;
      text-align: left;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    button:hover { background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22); }
    button:active { transform: scale(.99); }
    button.primary { background: rgba(116,192,252,.16); border-color: rgba(116,192,252,.35); font-weight: 800; text-align: center; }
    button.danger { background: rgba(255,107,107,.14); border-color: rgba(255,107,107,.30); }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 900;
      letter-spacing: .6px;
    }
    .chip.decoy { opacity: .78; background: rgba(255,107,107,.10); border-color: rgba(255,107,107,.22); }
    .chip.good  { background: rgba(81,207,102,.10); border-color: rgba(81,207,102,.22); }
    .footerActions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; margin-top: 14px; }
    .inputRow { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    input[type="text"] {
      flex: 1; min-width: 210px;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 16px;
      outline: none;
    }
    input[type="text"]:focus { border-color: rgba(116,192,252,.45); box-shadow: 0 0 0 4px rgba(116,192,252,.12); }
    .note {
      font-size: 14px;
      color: rgba(255,255,255,.72);
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.14);
      padding: 10px 12px;
      border-radius: 14px;
      margin-top: 12px;
    }
    .story {
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 14px 14px;
      margin-top: 12px;
      color: rgba(255,255,255,.78);
    }
    .small { font-size: 13px; color: rgba(255,255,255,.62); }
    .progress { height: 8px; border-radius: 999px; background: rgba(255,255,255,.08); overflow: hidden; border: 1px solid rgba(255,255,255,.10); }
    .progress > div { height: 100%; width: 0%; background: rgba(116,192,252,.55); }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Escape Room Matem√°tico">
    <header>
      <div class="badge" id="badgeStage">üóùÔ∏è Sala 1/5 ¬∑ Pregunta 1/5</div>
      <div class="badge timer" id="badgeTimer">‚è≥ 12:00</div>
    </header>
    <main>
      <div class="panel">
        <div class="progress" aria-hidden="true"><div id="progressBar"></div></div>
        <div id="screen"></div>
      </div>
      <div class="small" style="margin-top:10px;">
        Consejo: pantalla completa (F11) para una experiencia tipo juego.
      </div>
    </main>
  </div>

<script>
const GAME = [{"targetWord": "MAGIA", "questions": [{"prompt": "Calcula: (‚àí3)+5√ó2‚àí4", "options": [{"text": "7", "letter": "X", "correct": false}, {"text": "‚àí1", "letter": "K", "correct": false}, {"text": "3", "letter": "I", "correct": true}]}, {"prompt": "Resuelve: 8‚àí(‚àí2)√ó3+1", "options": [{"text": "11", "letter": "B", "correct": false}, {"text": "15", "letter": "A", "correct": true}, {"text": "3", "letter": "G", "correct": false}]}, {"prompt": "Calcula: (‚àí5)√ó2+8√∑(‚àí4)", "options": [{"text": "‚àí12", "letter": "G", "correct": true}, {"text": "‚àí14", "letter": "O", "correct": false}, {"text": "‚àí8", "letter": "F", "correct": false}]}, {"prompt": "Resuelve: 12√∑(‚àí3)+(‚àí2)√ó5", "options": [{"text": "‚àí18", "letter": "U", "correct": false}, {"text": "‚àí6", "letter": "P", "correct": false}, {"text": "‚àí14", "letter": "A", "correct": true}]}, {"prompt": "Calcula: (‚àí6)+4√ó(‚àí2)‚àí3", "options": [{"text": "‚àí17", "letter": "M", "correct": true}, {"text": "‚àí13", "letter": "Q", "correct": false}, {"text": "‚àí11", "letter": "S", "correct": false}]}]}, {"targetWord": "BRUJA", "questions": [{"prompt": "¬øCu√°l es el 35% de 200?", "options": [{"text": "70", "letter": "J", "correct": true}, {"text": "65", "letter": "U", "correct": false}, {"text": "75", "letter": "M", "correct": false}]}, {"prompt": "Si el 60% de un n√∫mero es 48, ¬øcu√°l es el n√∫mero?", "options": [{"text": "80", "letter": "U", "correct": true}, {"text": "88", "letter": "M", "correct": false}, {"text": "72", "letter": "B", "correct": false}]}, {"prompt": "¬øQu√© porcentaje representa 18 de 72?", "options": [{"text": "30%", "letter": "Z", "correct": false}, {"text": "20%", "letter": "N", "correct": false}, {"text": "25%", "letter": "B", "correct": true}]}, {"prompt": "Un art√≠culo cuesta 150‚Ç¨. Si sube un 20%, ¬ønuevo precio?", "options": [{"text": "180‚Ç¨", "letter": "A", "correct": true}, {"text": "190‚Ç¨", "letter": "Z", "correct": false}, {"text": "170‚Ç¨", "letter": "I", "correct": false}]}, {"prompt": "Bici de 200‚Ç¨ con descuento del 15%. ¬øPrecio final?", "options": [{"text": "160‚Ç¨", "letter": "P", "correct": false}, {"text": "170‚Ç¨", "letter": "R", "correct": true}, {"text": "180‚Ç¨", "letter": "K", "correct": false}]}]}, {"targetWord": "HADAS", "questions": [{"prompt": "Si 4 m de tela cuestan 24‚Ç¨, ¬øcu√°nto 7 m?", "options": [{"text": "38‚Ç¨", "letter": "C", "correct": false}, {"text": "46‚Ç¨", "letter": "C", "correct": false}, {"text": "42‚Ç¨", "letter": "A", "correct": true}]}, {"prompt": "Coche: 6 L/100 km. En 350 km, ¬ølitros?", "options": [{"text": "18 L", "letter": "J", "correct": false}, {"text": "21 L", "letter": "A", "correct": true}, {"text": "24 L", "letter": "T", "correct": false}]}, {"prompt": "18 pasteles ‚Üí 450 g az√∫car. 12 pasteles ‚Üí ¬øg?", "options": [{"text": "350 g", "letter": "Y", "correct": false}, {"text": "250 g", "letter": "T", "correct": false}, {"text": "300 g", "letter": "D", "correct": true}]}, {"prompt": "8 obreros hacen un muro en 15 d√≠as. 12 obreros ‚Üí ¬ød√≠as?", "options": [{"text": "10", "letter": "H", "correct": true}, {"text": "8", "letter": "S", "correct": false}, {"text": "12", "letter": "K", "correct": false}]}, {"prompt": "1 manguera llena piscina en 12 h. 3 mangueras ‚Üí ¬øh?", "options": [{"text": "6", "letter": "M", "correct": false}, {"text": "4", "letter": "S", "correct": true}, {"text": "3", "letter": "G", "correct": false}]}]}, {"targetWord": "HECHO", "questions": [{"prompt": "Calcula: (‚àí2)√ó(‚àí7)‚àí9", "options": [{"text": "23", "letter": "E", "correct": true}, {"text": "5", "letter": "B", "correct": false}, {"text": "‚àí23", "letter": "F", "correct": false}]}, {"prompt": "Resuelve: 30√∑(‚àí5)+4", "options": [{"text": "‚àí2", "letter": "C", "correct": true}, {"text": "‚àí10", "letter": "Q", "correct": false}, {"text": "10", "letter": "O", "correct": false}]}, {"prompt": "Calcula: 6¬≤‚àí5√ó7", "options": [{"text": "‚àí1", "letter": "V", "correct": false}, {"text": "1", "letter": "H", "correct": true}, {"text": "11", "letter": "A", "correct": false}]}, {"prompt": "Si el 25% de un n√∫mero es 15, ¬øcu√°l es el n√∫mero?", "options": [{"text": "60", "letter": "O", "correct": true}, {"text": "40", "letter": "V", "correct": false}, {"text": "75", "letter": "Z", "correct": false}]}, {"prompt": "Un precio de 80‚Ç¨ baja un 10%. ¬øPrecio final?", "options": [{"text": "70‚Ç¨", "letter": "R", "correct": false}, {"text": "72‚Ç¨", "letter": "H", "correct": true}, {"text": "68‚Ç¨", "letter": "A", "correct": false}]}]}, {"targetWord": "PODER", "questions": [{"prompt": "Calcula: (‚àí4)+3√ó(‚àí5)", "options": [{"text": "‚àí19", "letter": "R", "correct": true}, {"text": "‚àí11", "letter": "Z", "correct": false}, {"text": "11", "letter": "F", "correct": false}]}, {"prompt": "Resuelve: 2,4 √ó 10", "options": [{"text": "2,4", "letter": "G", "correct": false}, {"text": "0,24", "letter": "R", "correct": false}, {"text": "24", "letter": "E", "correct": true}]}, {"prompt": "¬øQu√© fracci√≥n es equivalente a 0,75?", "options": [{"text": "3/4", "letter": "D", "correct": true}, {"text": "2/5", "letter": "U", "correct": false}, {"text": "1/3", "letter": "V", "correct": false}]}, {"prompt": "Si 5 cuadernos cuestan 12‚Ç¨, ¬øcu√°nto 8 cuadernos?", "options": [{"text": "20‚Ç¨", "letter": "N", "correct": false}, {"text": "18‚Ç¨", "letter": "J", "correct": false}, {"text": "19,2‚Ç¨", "letter": "P", "correct": true}]}, {"prompt": "Una receta para 6 personas usa 300 g. Para 10 personas, ¬øg?", "options": [{"text": "450 g", "letter": "X", "correct": false}, {"text": "500 g", "letter": "O", "correct": true}, {"text": "600 g", "letter": "C", "correct": false}]}]}];
const ALL_WORDS = ["MAGIA", "BRUJA", "HADAS", "HECHO", "PODER"];

const storyByBlock = [
  { title: "La Biblioteca Prohibida", text: "El guardi√°n ha sellado la salida. Para abrir la primera puerta, re√∫ne 5 letras escondidas en libros encantados." },
  { title: "El Taller de la Bruja Relojera", text: "La bruja detuvo el tiempo. Responde con cuidado: los fallos te entregan letras trampa que confunden la clave." },
  { title: "El Bosque de las Hadas", text: "Las hadas ocultan la palabra entre proporciones. Re√∫ne letras aut√©nticas‚Ä¶ y descarta los se√±uelos." },
  { title: "El Sal√≥n del Hechizo Incompleto", text: "La sala vibra. Cada error deja una runa falsa. Descifra la palabra antes de que termine la cuenta atr√°s." },
  { title: "La C√°mara del Poder", text: "√öltima puerta. Si descifras la palabra final, el portal se abrir√° y el hechizo quedar√° completo." },
];

let blockIndex = 0;
let qIndex = 0;
let letters = []; // {ch, good:boolean}
let timer = null;
let remaining = 12 * 60; // seconds

function norm(s) {
  return (s || "").trim().toUpperCase()
    .replaceAll("√Å","A").replaceAll("√â","E").replaceAll("√ç","I").replaceAll("√ì","O").replaceAll("√ö","U").replaceAll("√ú","U").replaceAll("√ë","N");
}

function fmtTime(sec) {
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}

function setHeader() {
  const badgeStage = document.getElementById("badgeStage");
  badgeStage.textContent = `üóùÔ∏è Sala ${blockIndex+1}/5 ¬∑ ${qIndex<=4 ? `Pregunta ${qIndex+1}/5` : "Palabra"}`;

  const badgeTimer = document.getElementById("badgeTimer");
  badgeTimer.textContent = `‚è≥ ${fmtTime(remaining)}`;
  badgeTimer.classList.toggle("danger", remaining <= 60);

  const progress = document.getElementById("progressBar");
  const pct = Math.min(100, Math.round((qIndex / 5) * 100));
  progress.style.width = pct + "%";
}

function startTimer() {
  stopTimer();
  remaining = 12 * 60;
  setHeader();
  timer = setInterval(() => {
    remaining -= 1;
    if (remaining <= 0) {
      remaining = 0;
      setHeader();
      stopTimer();
      renderTimeUp();
      return;
    }
    setHeader();
  }, 1000);
}

function stopTimer() {
  if (timer) { clearInterval(timer); timer = null; }
}

function renderStart() {
  qIndex = 0;
  letters = [];
  blockIndex = 0;
  startTimer();

  const el = document.getElementById("screen");
  el.innerHTML = `
    <h1>ü™Ñ Escape Room Matem√°tico</h1>
    <p>En cada sala respondes 5 preguntas. Cada respuesta te da una letra (a veces falsa). Al final escribe la palabra m√°gica para abrir la puerta.</p>
    <div class="story">
      <b>${storyByBlock[0].title}</b><br/>
      ${storyByBlock[0].text}
    </div>
    <div class="note">
      ‚è±Ô∏è Cada sala tiene <b>12 minutos</b>. Si el tiempo llega a 0, la sala se reinicia.
    </div>
    <div class="footerActions">
      <button class="primary" id="btnGo">COMENZAR</button>
    </div>
  `;
  document.getElementById("btnGo").onclick = () => renderQuestion();
  setHeader();
}

function renderLettersChips() {
  if (!letters.length) return `<p class="small">A√∫n no tienes letras.</p>`;
  return `
    <div class="chips" aria-label="Letras conseguidas">
      ${letters.map(l => `<span class="chip ${l.good ? "good" : "decoy"}">${l.ch}</span>`).join("")}
    </div>
    <p class="small">Las letras rojas son sospechosas: suelen venir de respuestas incorrectas.</p>
  `;
}

function renderQuestion() {
  setHeader();
  const block = GAME[blockIndex];
  const q = block.questions[qIndex];
  const el = document.getElementById("screen");
  const story = storyByBlock[blockIndex];

  el.innerHTML = `
    <h1>${story.title}</h1>
    <p>${story.text}</p>
    <div class="question">üß© Pregunta ${qIndex+1}:</div>
    <div class="question">${q.prompt}</div>
    <div class="answers" id="answers"></div>

    <div style="margin-top:12px;">
      <h2 style="margin:0 0 6px 0;">Tus letras</h2>
      ${renderLettersChips()}
    </div>
  `;

  const answersDiv = document.getElementById("answers");
  q.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.innerHTML = `<b>${String.fromCharCode(65+i)})</b> ${opt.text}`;
    btn.onclick = () => handleAnswer(opt);
    answersDiv.appendChild(btn);
  });
}

function handleAnswer(opt) {
  letters.push({ ch: opt.letter, good: !!opt.correct });

  const el = document.getElementById("screen");
  el.innerHTML = `
    <h1>${opt.correct ? "‚úÖ Correcto" : "‚ùå Incorrecto"}</h1>
    <p>${opt.correct ? "Has ganado una letra aut√©ntica." : "Has recibido una letra trampa‚Ä¶ pero sigues avanzando."}</p>

    <div class="story" style="margin-top:10px;">
      <b>Letra obtenida:</b>
      <div style="font-size:46px; font-weight:900; letter-spacing:4px; margin-top:6px;">${opt.letter}</div>
      <div style="margin-top:10px;">
        <b>Tus letras:</b>
        ${renderLettersChips()}
      </div>
    </div>

    <div class="footerActions">
      <button class="primary" id="btnNext">${qIndex < 4 ? "Siguiente pregunta" : "Ir a la palabra"}</button>
    </div>
  `;

  document.getElementById("btnNext").onclick = () => {
    qIndex += 1;
    if (qIndex <= 4) renderQuestion();
    else renderWordGate();
  };
  setHeader();
}

function renderWordGate(msg="") {
  setHeader();
  const target = GAME[blockIndex].targetWord;

  const el = document.getElementById("screen");
  el.innerHTML = `
    <h1>üö™ Puerta de la Sala ${blockIndex+1}</h1>
    <p>Escribe la palabra m√°gica (5 letras) para abrir la puerta.</p>

    <div style="margin-top:12px;">
      <h2 style="margin:0 0 6px 0;">Tus letras</h2>
      ${renderLettersChips()}
    </div>

    <div class="note">
      ‚úçÔ∏è Escribe la palabra. Si te equivocas, aparecer√°n letras trampa adicionales.
    </div>

    <div class="inputRow">
      <input id="wordInput" type="text" maxlength="12" placeholder="Escribe aqu√≠ la palabra..." autocomplete="off" />
      <button class="primary" id="btnCheck">COMPROBAR</button>
    </div>
    ${msg ? `<p style="margin-top:10px; color: rgba(255,255,255,.85);">${msg}</p>` : ""}

    <div class="footerActions">
      <button id="btnRestart" class="danger">Reiniciar sala</button>
    </div>
  `;

  const input = document.getElementById("wordInput");
  input.focus();

  document.getElementById("btnCheck").onclick = () => {
    const guess = norm(input.value);
    if (!guess) return;

    if (guess === norm(target)) {
      handleBlockWin();
    } else {
      const pool = "XYZJKQW";
      const decoy = pool.charAt(Math.floor(Math.random()*pool.length));
      letters.push({ ch: decoy, good: false });
      renderWordGate(`‚ùå No se abre. Aparece una runa falsa: <b>${decoy}</b>. Intenta otra vez.`);
    }
  };

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") document.getElementById("btnCheck").click();
  });

  document.getElementById("btnRestart").onclick = () => restartBlock();
}

function handleBlockWin() {
  const el = document.getElementById("screen");
  stopTimer();

  const solvedWord = GAME[blockIndex].targetWord;

  el.innerHTML = `
    <h1>‚ú® Puerta abierta</h1>
    <p>La palabra era <b>${solvedWord}</b>. ¬°Avanzas a la siguiente sala!</p>

    <div class="story" style="margin-top:10px;">
      <b>Palabras completadas:</b>
      <div class="chips" style="margin-top:10px;">
        ${ALL_WORDS.slice(0, blockIndex+1).map(w => `<span class="chip good">${w}</span>`).join("")}
      </div>
    </div>

    <div class="footerActions">
      <button class="primary" id="btnCont">${blockIndex < 4 ? "Entrar en la siguiente sala" : "Final"}</button>
    </div>
  `;

  document.getElementById("btnCont").onclick = () => {
    if (blockIndex < 4) {
      blockIndex += 1;
      qIndex = 0;
      letters = [];
      startTimer();
      renderQuestion();
    } else {
      renderGameWin();
    }
  };
  setHeader();
}

function renderGameWin() {
  stopTimer();
  const el = document.getElementById("screen");
  el.innerHTML = `
    <h1>üèÜ ¬°Escape completado!</h1>
    <p>Has reunido todas las palabras m√°gicas:</p>
    <div class="chips" style="margin-top:12px;">
      ${ALL_WORDS.map(w => `<span class="chip good">${w}</span>`).join("")}
    </div>
    <div class="story" style="margin-top:14px;">
      El portal se abre. El hechizo se completa‚Ä¶ y la clase ha recuperado el conocimiento perdido.
    </div>
    <div class="footerActions" style="margin-top:14px;">
      <button class="primary" id="btnAgain">Jugar de nuevo</button>
    </div>
  `;
  document.getElementById("btnAgain").onclick = () => renderStart();
}

function renderTimeUp() {
  const el = document.getElementById("screen");
  el.innerHTML = `
    <h1>‚è∞ ¬°Se acab√≥ el tiempo!</h1>
    <p>La Sala ${blockIndex+1} se reinicia. ¬°Ahora ya sabes por d√≥nde van las pistas!</p>
    <div class="footerActions">
      <button class="primary" id="btnRetry">Reintentar sala</button>
      <button class="danger" id="btnHome">Volver al inicio</button>
    </div>
  `;
  document.getElementById("btnRetry").onclick = () => restartBlock();
  document.getElementById("btnHome").onclick = () => renderStart();
}

function restartBlock() {
  stopTimer();
  qIndex = 0;
  letters = [];
  startTimer();
  renderQuestion();
}

// Boot
renderStart();
</script>
</body>
</html>
